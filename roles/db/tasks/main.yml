- name: mysql allow ex
  shell: |
    sudo mysql -e "SELECT user, host FROM mysql.user;"
    sudo mysql -e "RENAME USER '$(DB_USER)'@'localhost' TO '$(DB_USER)'@'%';"
    make reset-mysql
    sudo mysql -e "SELECT user, host FROM mysql.user;"
    curl -X POST -H "Content-type: application/json" \
      -d '{"content": "MySQL/MariaDBのユーザーへの外部からのアクセスを許可しました。`bind_address`が`0.0.0.0`になっていることを確かめてください。"}' $(WEBHOOK_URL) -s -o /dev/null

- name: Get DB sample
  shell: |
    $(eval TABLES := $(shell mysql -h$(DB_HOST) -P$(DB_PORT) -u$(DB_USER) -p$(DB_PASS) $(DB_NAME) -e 'SHOW TABLES;' -sN))
    echo "Data Samples" > /temp/sample.txt
    for table in $(TABLES); do \
      echo "" >> /temp/sample.txt && \
      echo "-----$$table-----" >> /temp/sample.txt && \
      mysql -h$(DB_HOST) -P$(DB_PORT) -u$(DB_USER) -p$(DB_PASS) $(DB_NAME) -t -e "SELECT * FROM $$table LIMIT 10;" >> /temp/sample.txt; \
    done
    curl -X POST -F txt=@/temp/sample.txt $(WEBHOOK_URL) -s -o /dev/null

- name: Get DB status
  shell: |
    echo "-----CPU Info-----" > /temp/status.txt
    grep processor /proc/cpuinfo >> /temp/status.txt && echo "" >> /temp/status.txt
    echo "-----Memory Info-----" >> /temp/status.txt
    free -h >> /temp/status.txt && echo "" >> /temp/status.txt
    echo "-----Service Info-----" >> /temp/status.txt
    systemctl list-units --type=service --state=running >> /temp/status.txt && echo "" >> /temp/status.txt
    echo "-----DB Table & Column Info-----" >> /temp/status.txt
    mysql -h$(DB_HOST) -P$(DB_PORT) -u$(DB_USER) -p$(DB_PASS) -t \
      -e 'USE information_schema; SELECT table_name, column_name FROM columns WHERE table_schema="$(DB_NAME)";' >> /temp/status.txt
    curl -X POST -F txt=@/temp/status.txt $(WEBHOOK_URL) -s -o /dev/null
